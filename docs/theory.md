# theory

## 1. システム理論の全体像

本プロジェクトは outside-in 型の光学モーションキャプチャです。

- 各 RasPi が画像から反射マーカの 2D 観測値を抽出
- Host が multi-view 幾何で 3D 点群を推定
- 時系列フィルタと剛体推定で pose(位置+姿勢)を算出
- SteamVR 向けに tracker pose を出力

要点は「同期」「対応付け」「較正」「剛体同定」の4本柱です。

## 2. 観測モデル

各カメラで観測される点は画像座標系で表され、以下を送信します。

- `camera_id`
- `timestamp`
- `frame_index`
- `blobs`: `{x, y, area}` の配列

推奨仕様:
- `timestamp`: `int64` Unix epoch(us)
- `frame_index`: `uint32` 単調増加(カメラごと)

画像そのものは送らず、Host 側で幾何計算します。

## 3. 幾何パイプライン

### 3.1 対応付け

候補点の対応付けはエピポーラ幾何と再投影誤差を併用します。

1. 仮の対応を作る
2. 三角測量で 3D 仮説を得る
3. 各視点へ再投影して誤差を評価
4. 誤差最小の組み合わせを採用

### 3.2 三角測量

- DLT を基礎とし、必要に応じて非線形最適化で補正
- 較正済み内部/外部パラメータを使用

### 3.3 Rectification

Rectification は Host 側で実施し、RasPi は生画像座標を送ります。

## 4. 時間同期理論

同期は以下の3層で吸収します。

1. クロック同期(PTP等)
2. Host 側の timestamp ペアリング
3. フィルタによるジッタ/欠損吸収

目標は実運用で 2-5 ms の撮影タイミング差です。

推奨 degrade 戦略:
- 許容窓外フレームは短時間補間で継続
- 連続失敗時は予測のみへ遷移
- 同期復帰後は自動再同期

## 5. 状態推定と剛体推定

### 5.1 点トラック

- 観測点に対してトラック管理を行い、欠損時は予測で補完
- Kalman フィルタは姿勢推定前の安定化に使用

### 5.2 クラスタリング

- 第一候補は DBSCAN
- 反射ノイズや外れ値に強く、点数変動に比較的頑健

### 5.3 姿勢推定

- 主方式: Kabsch (3D-3D)
- フォールバック: PnP / 3点PnP / 予測継続

## 6. SteamVR 連携理論

Host 内部座標を SteamVR 座標に変換し、5トラッカーへ割り当てます。

- head
- chest
- waist
- left_foot
- right_foot

出力方式は OpenVR Driver を第一候補とします。

## 7. 未解決の理論課題

- ペアリング許容窓(環境別)の定量化
- 姿勢推定フォールバック閾値の同定
- 5剛体の同定評価関数(重み設計)の最適化
- DBSCAN パラメータの環境適応則
